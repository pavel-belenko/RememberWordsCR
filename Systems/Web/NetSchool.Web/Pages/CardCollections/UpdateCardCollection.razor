@page "/update-collection"
@using NetSchool.Web.Components
@using Microsoft.AspNetCore.Authorization
@using NetSchool.Web.Entities.CardCollections
@using NetSchool.Web.Services.CardCollections
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ICardCollectionsService cardService
@inject NavigationManager NavManager

@* @attribute [Authorize] *@
@layout MainLayout

<PageTitle>Create card collection</PageTitle>
<MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="SaveCollection">Save</MudButton>

<MudContainer>
    <MudGrid>
        <MudItem xs="12">
            <MudPaper>
                <MudTextField Label="Collection name" @bind-Value="collection.Name"
                              For="@(() => collection.Name)"
                              Required="true"
                              RequiredError="Collection name is required!"
                              MaxLength="100">
                </MudTextField>
                @foreach (var (component, index) in collection.Cards.Select((c, i) => (c, i)))
                {
                    <MudCard>
                        <MudCardContent>
                            <MudGrid>
                                <MudItem xs="10">
                                    <MudTextField Value="@component.Front" Label="Term" Variant="Variant.Filled" Style="width: 100%" />
                                    <MudTextField Value="@component.Reverse" Label="Definition" Variant="Variant.Filled" Style="width: 100%" />
                                </MudItem>
                                <MudItem xs="2">
                                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="(()=>EditCard(index))">Edit</MudButton>
                                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="(()=>DeleteCard(index))">Delete</MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>
                    @if (index != collection.Cards.Count - 1)
                    {
                        <div style="height: 20px;"></div>
                    }
                }
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddCard">Add card</MudButton>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>


@code {
    private CardCollectionModel collection;
    private UpdateModel updateModel;
    private string searchString = string.Empty;
    [SupplyParameterFromQuery] public Guid collectionId { get; set; }

    protected override void OnInitialized()
    {
        collection = new CardCollectionModel();
        collection.Cards = new List<CardModel>();

        updateModel = new UpdateModel();
        updateModel.Cards = new List<CardModel>();
    }

    protected override async Task OnInitializedAsync()
    {
        if (collectionId == Guid.Empty)
            return;

        var collectionModel = await cardService.Get(collectionId);

        if (collectionModel == null)
            return;

        collection.Name = collectionModel.Name;
        collection.UserId = collectionModel.UserId;
        collection.Cards = collectionModel.Cards;
    }

    private async Task AddCard()
    {
        var parameters = new DialogParameters { };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Large, FullWidth = true };

        var dialog = await DialogService.ShowAsync<CardDialog>("Add card", parameters, options);
        var result = await dialog.Result;

        if (result.Canceled)
            return;

        var cardModel = ((CardDialog)dialog.Dialog).Model;
        var newCard = new CardModel { Id = Guid.NewGuid(), Front = cardModel.Front, Reverse = cardModel.Reverse };

        collection.Cards.Add(newCard);
        updateModel.Cards.Add(newCard);
    }

    private async Task EditCard(int index)
    {
        var parameters = new DialogParameters();
        parameters.Add("Model", new CardModel { Id = collection.Cards[index].Id, Front = collection.Cards[index].Front, Reverse = collection.Cards[index].Reverse });

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Large, FullWidth = true };
        var dialog = DialogService.Show<CardDialog>("Edit card", parameters, options);
        var result = await dialog.Result;

        if (result.Canceled)
            return;

        var cardModel = ((CardDialog)dialog.Dialog).Model;

        collection.Cards[index] = cardModel;

        var existCard = updateModel.Cards.FirstOrDefault(x => x.Id == cardModel.Id);
        if (existCard == null)
        {
            updateModel.Cards.Add(cardModel);
        }
        else
        {
            existCard.Front = cardModel.Front;
            existCard.Reverse = cardModel.Reverse;
        }
    }

    private async Task DeleteCard(int index)
    {
        var parameters = new DialogParameters();
        parameters.Add("ContentText", "Do you really want to delete this card? This process cannot be undone.");
        parameters.Add("ButtonText", "Delete");
        parameters.Add("Color", Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Delete collection", parameters, options);
        var result = await dialog.Result;

        if (result.Canceled)
            return;

        var cardToDelete = collection.Cards[index];

        updateModel.Cards.Remove(cardToDelete);
        collection.Cards.RemoveAt(index);
    }

    private async Task SaveCollection()
    {
        try
        {
            updateModel.Name = collection.Name;
            await cardService.Update(collectionId, updateModel);

            NavManager.NavigateTo("/collections");
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }
}